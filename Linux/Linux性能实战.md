# 概览

性能分析步骤：

1. 选择指标评估应用程序和系统性能
2. 为应用程序和系统设置性能目标
3. 进行性能基准测试
4. 性能分析定位瓶颈
5. 优化系统和应用程序
6. 性能监控和告警

总结起来就是：指标-测试-优化



下图是Linux常用性能工具图谱

![img](Linux性能实战_images/linux_perf_tools_full-20200918112736933.png)

# CPU

## 平均负载

什么是平均负载？

平均负载是指单位时间内，系统处于可运行状态可不可中断状态的平均进程数，也就是平均活跃进程数，它和CPU使用率并没有直接关系。

- 可运行状态的进程，是指正在使用CPU或者正在等待CPU的进程，常用ps命令看到处于R（Running或Runnable）的进程
- 不可中断状态的进程则是处于内核态关键流程中的进程，并且这些流程是不可打断的，如最常见的是等待硬件设备的I/O响应，ps命令中看到的D状态的进程



在评判系统平均负载时，需要了解系统的CPU个数，可以使用`top`或者从`proc/cpuinfo`中读取

```bash
grep 'model name' /proc/cpuinfo|wc -l
```

当平均负载大于CPU个数时，系统已经出现了过载，一般超过70%应该需要排查负载高的原因。



CPU使用率表示的是单位时间内CPU繁忙情况的统计，而平均负载是指单位时间内处于可运行状态和不可中断状态的进程数，不仅包含了正在使用CPU的进程，还包括了CPU和等待I/O的进程

- CPU密集型进程，使用大量CPU会导致平均负载升高，此时CPU使用率也是很高的
- I/O密集型进程，等待I/O会导致平均负载升高，但CPU使用率不一定很高
- 大量等待CPU的进程调度也会导致平均负载升高，CPU使用率也会比较高



可以使用下工具进行CPU的平均负载测试（apt-get install -y stress stress-ng sysstat）

- `uptime`：查看平均负载的工具
- `stress`： Linux 系统压力测试工具
- `stress-ng`：stress的高级版本
- `mpstat`：是一个常用的多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，以及所有 CPU 的平均指标。
- `pidstat`：pidstat 是一个常用的进程性能分析工具，用来实时查看进程的 CPU、内存、I/O 以及上下文切换等性能指标。

打开三个终端

**终端一**

```
//在终端中每次输入完以下指令后，在看终端二、三
stress -c 1 --timeout 600
stress -i 1 --hdd 1 --timeout 600
stress -c 8 --timeout 600
```

**终端二**

```
watch -d uptime
```

**终端三**

```
mpstat -P ALL 5
pidstat -u 5
```



